<script>
/* ===== Telegram WebApp boot ===== */
const tg = window.Telegram?.WebApp;
try {
  tg?.ready();
  tg?.expand();
  const bg = tg?.themeParams?.bg_color;
  if (bg) document.body.style.backgroundColor = bg;
} catch {}

/* ===== API base & endpoints =====
   Defaults to same-origin backend. If you host frontend elsewhere,
   set <script>window.API_BASE="https://your-service.onrender.com"</script> in <head>.
*/
const API_BASE = (window.API_BASE && window.API_BASE.replace(/\/+$/,'')) || location.origin;
const ENDPOINTS = {
  CONFIG: `${API_BASE}/config`,
  ROLL: `${API_BASE}/roll`,
  DAILY_TOP: `${API_BASE}/leaderboard/daily`
};

/* Always include Telegram user id if available */
const TG_USER_ID = tg?.initDataUnsafe?.user?.id ? String(tg.initDataUnsafe.user.id) : null;
function apiFetch(url, opts = {}) {
  const headers = new Headers(opts.headers || {});
  if (TG_USER_ID) headers.set("X-Tg-Id", TG_USER_ID);
  return fetch(url, { ...opts, headers });
}

/* ===== UI elements ===== */
const rollBtn = document.getElementById("roll-btn");
const rollsLeftEl = document.getElementById("rolls-left");
const die1 = document.getElementById("die1");
const die2 = document.getElementById("die2");
const snapshot = document.getElementById("snapshot");
const rulesBtn = document.getElementById("rules-btn");
const leaderboardBtn = document.getElementById("leaderboard-btn");

/* ===== Helpers ===== */
function lockButton(seconds){
  let t = Math.max(1, Math.ceil(seconds));
  rollBtn.disabled = true;
  const orig = rollBtn.textContent;
  rollBtn.textContent = `Wait ${t}s`;
  const timer = setInterval(()=>{
    t -= 1;
    if (t <= 0){
      clearInterval(timer);
      rollBtn.disabled = false;
      rollBtn.textContent = orig;
    } else {
      rollBtn.textContent = `Wait ${t}s`;
    }
  }, 1000);
}

/* ===== API calls ===== */
async function loadConfig(){
  try{
    const r = await apiFetch(ENDPOINTS.CONFIG, { method: "GET" });
    if (!r.ok) throw new Error("config fetch failed");
    const d = await r.json();
    const left = Number(d.rolls_left ?? 0);
    const limit = Number(d.daily_limit ?? 50);
    rollsLeftEl.textContent = `Rolls Left: ${left}/${limit}`;
  }catch(e){
    rollsLeftEl.textContent = "Rolls Left: â€”";
  }
}

async function doRoll(){
  const key = crypto.getRandomValues(new Uint32Array(4)).join("-");
  try{
    const r = await apiFetch(ENDPOINTS.ROLL, {
      method: "POST",
      headers: { "X-Idempotency-Key": key }
    });
    const d = await r.json();

    if (d?.error === "COOLDOWN_ACTIVE"){
      lockButton(d.seconds_remaining || 4);
      tg?.HapticFeedback?.notificationOccurred?.("warning");
      return;
    }
    if (d?.error === "DAILY_LIMIT_REACHED"){
      const limit = Number(d.daily_limit ?? 50);
      rollsLeftEl.textContent = `Rolls Left: 0/${limit}`;
      rollBtn.disabled = true;
      rollBtn.textContent = "Come back after midnight UTC";
      tg?.HapticFeedback?.notificationOccurred?.("warning");
      return;
    }
    if (d?.error){
      alert(d.error);
      return;
    }

    // Success
    die1.src = `/static/dice/default/${d.d1}.png`;
    die2.src = `/static/dice/default/${d.d2}.png`;
    const left = Number(d.rolls_left ?? 0);
    const limit = Number(d.daily_limit ?? 50);
    rollsLeftEl.textContent = `Rolls Left: ${left}/${limit}`;
    await loadSnapshot();
    try { new BroadcastChannel('dice-events').postMessage({ type:'rolled' }); } catch {}
    lockButton(4);
    tg?.HapticFeedback?.impactOccurred?.("light");
  }catch(e){
    alert("Network error. Please try again.");
  }
}

async function loadSnapshot(){
  try{
    const r = await apiFetch(`${ENDPOINTS.DAILY_TOP}?limit=3`);
    if (!r.ok) throw new Error();
    const d = await r.json();
    const items = (d.leaderboard || []).map(it =>
      `<div class="item"><span>#${it.rank} â€” ${it.user}</span><span>${it.score}</span></div>`
    );
    snapshot.innerHTML = items.join("") || `<div class="item"><span>No rolls yet</span><span>â€”</span></div>`;
  }catch(e){
    snapshot.innerHTML = `<div class="item"><span>Loadingâ€¦</span><span>â€”</span></div>`;
  }
}

/* ===== Events ===== */
rollBtn.addEventListener("click", doRoll);
rulesBtn.addEventListener("click", ()=> alert(
`ðŸŽ² How to Play

â€¢ You get 50 rolls per day.
â€¢ Each roll uses two dice (2â€“12).
â€¢ Daily standings reset at midnight UTC.
â€¢ Weekly standings add up your daily totals.

Good luck!`
));
leaderboardBtn.addEventListener("click", ()=> window.location.href = "/web/leaderboard.html");

/* ===== Init ===== */
loadConfig();
loadSnapshot();
</script>
